<!DOCTYPE html>
<html lang="{{ lang() }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HALO - {{ g.i18n.get('output.monthly_stats') }}</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        /* Print styles for monthly statistics */
        @media print {
            /* Set page margins */
            @page {
                margin: 0cm;
            }
            
            /* Remove all body margins and padding */
            body {
                margin: 0 !important;
                padding: 0 !important;
            }
            
            /* Hide header, footer, modal chrome, and backdrop */
            header, footer, .modal-header, .modal-footer, .btn-close,
            nav, .navbar, .modal-backdrop {
                display: none !important;
            }
            
            /* Hide chart modal by default when printing stats */
            #chart-modal {
                display: none !important;
            }
            
            /* Show results modal by default */
            #results-modal {
                position: static !important;
                display: block !important;
            }
            
            /* When chart modal has 'show' class, display it and hide results */
            #chart-modal.show {
                position: static !important;
                display: block !important;
            }
            
            #chart-modal.show ~ #results-modal,
            body:has(#chart-modal.show) #results-modal {
                display: none !important;
            }
            
            .modal {
                position: static !important;
                display: block !important;
            }
            
            .modal-dialog {
                max-width: 100% !important;
                width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
                max-height: none !important;
                height: auto !important;
            }
            
            .modal-content {
                border: none !important;
                box-shadow: none !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            .modal-body {
                overflow: visible !important;
                max-height: none !important;
                padding: 0 !important;
                margin: 0 !important;
                background-color: white !important;
            }
            
            /* White background for stats content */
            #stats-content {
                background-color: white !important;
            }
            
            /* Ensure title is visible */
            #chart-printable-title {
                display: block !important;
                margin-bottom: 10px !important;
            }
            
            /* Override scrollable */
            .modal-dialog-scrollable .modal-body {
                max-height: none !important;
                overflow-y: visible !important;
            }
        }
    </style>
</head>
<body class="d-flex flex-column min-vh-100">
    {% include 'header.html' %}

    <script>
        // Mark output menu as active
        document.addEventListener('DOMContentLoaded', () => {
            const menus = document.querySelectorAll('.menu-title');
            // Find Ausgabe/Output menu (6th menu item, index 5)
            if (menus[5]) menus[5].classList.add('active');
        });
    </script>

    <main class="container mt-4">
        <!-- Filter Selection Dialog Modal -->
        <div class="modal fade" id="filter-dialog" tabindex="-1" aria-labelledby="filterDialogLabel" aria-hidden="true" data-bs-backdrop="true" data-bs-keyboard="false">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="filterDialogLabel">
                            {{ g.i18n.get('output.monthly_stats') }}
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="filter-form">
                            <!-- Month/Year Selection -->
                            <div class="filter-group mb-3">
                                <label class="form-label fw-bold" id="month-year-label">
                                    {% if lang() == 'de' %}{{ g.i18n.get('monthly_stats.month_year_prompt') }}{% else %}{{ g.i18n.get('monthly_stats.month_year_prompt') }}{% endif %}
                                </label>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <select id="month-select" class="form-select">
                                            <option value="">-- {{ g.i18n.get('fields.select') }} --</option>
                                            <option value="1">01 - {{ g.i18n.get('months.1') }}</option>
                                            <option value="2">02 - {{ g.i18n.get('months.2') }}</option>
                                            <option value="3">03 - {{ g.i18n.get('months.3') }}</option>
                                            <option value="4">04 - {{ g.i18n.get('months.4') }}</option>
                                            <option value="5">05 - {{ g.i18n.get('months.5') }}</option>
                                            <option value="6">06 - {{ g.i18n.get('months.6') }}</option>
                                            <option value="7">07 - {{ g.i18n.get('months.7') }}</option>
                                            <option value="8">08 - {{ g.i18n.get('months.8') }}</option>
                                            <option value="9">09 - {{ g.i18n.get('months.9') }}</option>
                                            <option value="10">10 - {{ g.i18n.get('months.10') }}</option>
                                            <option value="11">11 - {{ g.i18n.get('months.11') }}</option>
                                            <option value="12">12 - {{ g.i18n.get('months.12') }}</option>
                                        </select>
                                    </div>
                                    <div class="col-6">
                                        <select id="year-select" class="form-select">
                                            <option value="">-- {{ g.i18n.get('fields.select') }} --</option>
                                        </select>
                                    </div>
                                </div>
                                <div id="month-year-error" class="text-danger mt-1" style="display:none;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer py-2">
                        <button type="button" id="btn-cancel-filter" class="btn btn-secondary btn-sm px-3">
                            {{ g.i18n.get('common.cancel') }}
                        </button>
                        <button type="button" id="btn-apply-filter" class="btn btn-primary btn-sm px-3">
                            <span id="apply-spinner" class="spinner-border spinner-border-sm me-1" role="status" style="display:none;"></span>
                            {{ g.i18n.get('common.ok') }}
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Modal -->
        <div class="modal fade" id="results-modal" tabindex="-1" aria-labelledby="resultsModalLabel" aria-hidden="true" data-bs-backdrop="true" data-bs-keyboard="false">
            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable" style="max-width: 90%; width: fit-content;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="results-modal-title"></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="stats-content"></div>
                    </div>
                    <div class="modal-footer d-flex justify-content-end gap-2">
                        <button type="button" id="btn-stats-chart" class="btn btn-secondary btn-sm px-4">{{ g.i18n.get('common.chart') or 'Grafik' }}</button>
                        <button type="button" id="btn-stats-print" class="btn btn-secondary btn-sm px-4">{{ g.i18n.get('common.print') }}</button>
                        <button type="button" id="btn-stats-save" class="btn btn-secondary btn-sm px-4">{{ g.i18n.get('common.save') }}</button>
                        <button type="button" id="btn-stats-ok" class="btn btn-primary btn-sm px-4">{{ g.i18n.get('common.ok') }}</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chart Modal -->
        <div class="modal fade" id="chart-modal" tabindex="-1" data-bs-keyboard="true">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">{{ g.i18n.get('monthly_stats.activity_title') or 'Haloaktivit√§t' }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <h5 id="chart-printable-title" style="text-align: center; margin-bottom: 10px;"></h5>
                        <div id="chart-subtitle" style="text-align: center; margin-bottom: 20px; color: #666; font-size: 0.9em;"></div>
                        <canvas id="activity-chart" style="max-height: 400px;"></canvas>
                    </div>
                    <div class="modal-footer gap-2">
                        <button type="button" id="btn-chart-print" class="btn btn-secondary btn-sm px-4">{{ g.i18n.get('common.print') }}</button>
                        <button type="button" id="btn-chart-save" class="btn btn-secondary btn-sm px-4">{{ g.i18n.get('common.save') }}</button>
                        <button type="button" id="btn-chart-close" class="btn btn-primary btn-sm px-4" data-bs-dismiss="modal">{{ g.i18n.get('common.ok') }}</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    {% include 'footer.html' %}

    <!-- Chart.js for activity visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <!-- Markdown parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- GitHub Markdown CSS for styled output -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@5.2.0/github-markdown.min.css">
    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}?v={{ static_version }}"></script>
    <script src="{{ url_for('static', filename='js/monthly_stats.js') }}?v={{ static_version }}"></script>
</body>
</html>
